#!/usr/bin/env bash

if [ -f ~/projects/dotfiles-private/.config/zsh/.work-dirs ]; then
    source ~/projects/dotfiles-private/.config/zsh/.work-dirs
fi

list=$(eval "eza -1 -X --no-quotes --only-dirs --absolute ~/projects ${WORK_DIRS} | grep -v ':' | grep -v '^$' ; printf '%s\n' ${ADDITIONAL_WORK_DIRS[@]}")

path=$1

if [[ -z $path ]]; then
    #path=$(printf '%s\n' "${list}" | fzf --no-preview --print-query)
    path=$(printf '%s\n' "${list}" | fzf --no-preview)
fi

if [[ -z $path ]]; then
    exit 0
fi

session_name=$(basename "$path" | tr . _)
tmux_running=$(pgrep tmux)

if [[ -z $TMUX ]] && [[ -z $tmux_running ]]; then
    tmux new-session -s $session_name -c $path "nvim"
    echo "exit"
    exit 0
fi

if ! tmux has-session -t="$session_name" 2>/dev/null; then
    if [ "$session_name" == "log" ]; then
        tmux new-session -d -s "$session_name" -c "$path"
        tmux send-keys -t $session_name "phplogs"
        tmux send-keys -t $session_name "C-m"
        tmux split-window -h -t "$session_name:1"
        tmux send-keys -t $session_name "locallogs"
        tmux send-keys -t $session_name "C-m"
    elif [ "$session_name" == "test" ]; then
        tmux new-session -d -s "$session_name" -c "$path"
        tmux send-keys -t $session_name "nvim"
        tmux send-keys -t $session_name "C-m"
        tmux split-window -h -l 30% -c "$path" -t "$session_name:1"
        tmux send-keys -t $session_name "runlocalserver"
        tmux send-keys -t $session_name "C-m"
        tmux split-window -v -l 50% -c "$path" -t "$session_name:1"
    elif [ "$session_name" == "newsboat" ]; then
        tmux new-session -d -c "~/" -s "$session_name" newsboat
    elif [ "$session_name" == "yazi" ]; then
        tmux new-session -d -s "$session_name" -c "$3" "yazi --chooser-file=/tmp/current-yazi-file"
    else
        tmux new-session -d -s "$session_name" -c "$path" "nvim"
    fi

fi

if [[ $2 == "popup" ]]; then
    tmux set-option -t $session_name detach-on-destroy on
fi

if [[ -z $2 && $TERM == *"tmux"* ]]; then
    tmux switch-client -t "$session_name"
else
    tmux a -t "$session_name"
fi
